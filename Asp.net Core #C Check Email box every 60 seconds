/*
    Include in Startup
    services.AddHostedService<ConsumeScopedServiceHostedService>();
     services.AddScoped<IScopedProcessingService, ScopedProcessingService>();
*/

internal interface IScopedProcessingService
{
    Task DoWork(CancellationToken stoppingToken);
    Task NightlyWork(CancellationToken stoppingToken);
    Task WmiObjectCheker(CancellationToken stoppingToken);
}

internal class ScopedProcessingService : IScopedProcessingService
{
    private readonly ILogger _logger;

    private EMAIL GetNewEmail;

    public ScopedProcessingService(ILogger<ScopedProcessingService> logger)
    {
        _logger = logger;
        this.GetNewEmail = new();
    }
    public async Task EmailTask(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            GetNewEmail.GetEmail();

            // Wait 60 seconds before checking again.
            await Task.Delay(60000, stoppingToken);
        }
    }

}

public class ConsumeScopedServiceHostedService : BackgroundService
{
    private readonly ILogger<ConsumeScopedServiceHostedService> _logger;

    public ConsumeScopedServiceHostedService(IServiceProvider services,
        ILogger<ConsumeScopedServiceHostedService> logger)
    {
        Services = services;
        _logger = logger;

    }

    public IServiceProvider Services { get; }

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {

        await DoWork(stoppingToken);
    }

    private async Task DoWork(CancellationToken stoppingToken)
    {

        using (var scope = Services.CreateScope())
        {
            var scopedProcessingService =
                scope.ServiceProvider
                    .GetRequiredService<IScopedProcessingService>();

            await scopedProcessingService.EmailTask(stoppingToken);

        }

    }

    public override async Task StopAsync(CancellationToken stoppingToken)
    {
        await base.StopAsync(stoppingToken);
    }
}

public class EMAIL
{

    private readonly string _UserName;
    private readonly string _Password;

    public EMAIL()
    {
        _UserName = "userName";
        _Password = "Password";

    }

    public void GetEmail(RUSDSQL _RusdSql)
    {
        try
        {
            ExchangeService _service;
            try
            {
                _service = new ExchangeService
                {
                    Credentials = new WebCredentials(_UserName, _Password)
                };
            }
            catch
            {
                Console.WriteLine("new ExchangeService failed. Press enter to exit:");
                return;
            }
            // This is the office365 webservice URL
            _service.Url = new Uri("https://outlook.office365.com/EWS/Exchange.asmx");

            // Prepare seperate class for writing email to the database
            try
            {
                SearchFilter sf = new SearchFilter.SearchFilterCollection(LogicalOperator.And, new SearchFilter.IsEqualTo(EmailMessageSchema.IsRead, false));
                EmailModel Rec = new();
                //ItemView is the first 100 unread messages
                var Emails = _service.FindItems(WellKnownFolderName.Inbox, new ItemView(100));
                Console.WriteLine(Emails.Count());

                foreach (EmailMessage email in _service.FindItems(WellKnownFolderName.Inbox, sf, new ItemView(100)))
                {

                    email.Load(new PropertySet(BasePropertySet.FirstClassProperties, ItemSchema.TextBody));

                    Rec = new EmailModel
                    {
                        From = email.From.Address
                    };

                    Rec.Body = email.Body;
                    Rec.Subject = email.Subject;
                    email.Load(new PropertySet(BasePropertySet.FirstClassProperties, ItemSchema.Attachments));
                    Console.WriteLine(email.Attachments.Count);

                    EmailAttachment AttFile = new();

                    foreach (Attachment attachment in email.Attachments)
                    {
                        if (attachment is FileAttachment)
                        {
                            FileAttachment fileAttachment = attachment as FileAttachment;
                            fileAttachment.Load();
                            AttFile = new EmailAttachment
                            {
                                FileName = fileAttachment.Name,
                                Data = fileAttachment.Content,
                                ContentType = fileAttachment.ContentType
                            };
                            Rec.Attacment.Add(AttFile);
                        }
                    }

                    email.Delete(DeleteMode.HardDelete);
                    //Do someting with Rec here... 
                }
            }
            catch (Exception e)
            {
                Console.WriteLine("An error has occured. \n:" + e.Message);
            }
        }
        catch (Exception ep)
        {
            Console.WriteLine(ep.Message);
        }
    }
}
